{% if items %}
<div class="space-y-6">

  {% for item in items %}
  <div class="border rounded-xl p-5 shadow-sm bg-white">

    <!-- Top Row -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 w-full">
      <div>
        <p class="text-lg font-semibold text-gray-800">
          {{ item.approval.approval_type.name }}
        </p>
        <p class="text-sm text-gray-500">
          Created: {{ item.approval.created_at|date:"M d, Y H:i" }}
        </p>
      </div>

      <div class="flex items-center gap-3 mt-3 sm:mt-0">

        <!-- Status badge -->
        <span class="flex items-center gap-1 text-xs px-3 py-1 rounded-full
          {% if item.approval.status == 'approved' %} bg-green-100 text-green-700
          {% elif item.approval.status == 'pending' %} bg-orange-100 text-orange-700
          {% else %} bg-gray-200 text-gray-700 {% endif %}">
          {{ item.approval.status|title }}
        </span>

        <!-- EDIT BUTTON -->
  {% if item.approval.level == 1 and item.approval.status == 'pending' %}
    <a href="{% url 'edit-approval' item.approval.id %}" 
       class="text-xs px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
      Edit
    </a>

  {% else %}
    <button disabled
            class="text-xs px-3 py-1 bg-gray-300 text-gray-600 rounded-md cursor-not-allowed">  
      Edit
    </button>
  {% endif %}



      </div>
    </div>

    {% if item.last_approval_date %}
    <p class="text-sm text-green-600 mb-3">
      Last approved: {{ item.last_approval_date|date:"M d, Y H:i" }}
    </p>
    {% endif %}

    <!-- Collapsible Timeline -->
    <div x-data="{ open: false }" class="mt-3">

      <button @click="open = !open"
              class="flex items-center gap-2 text-blue-600 hover:underline mb-2">
        <svg x-show="!open" class="h-5 w-5" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 5v14m7-7H5" />
        </svg>
        <svg x-show="open" class="h-5 w-5" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 12H5" />
        </svg>
        Show Timeline
      </button>

      <div x-show="open" x-collapse class="mt-2">
        <div class="flow-root">
          <ul class="relative border-l border-gray-200 dark:border-gray-700">

            {% for s in item.stages %}
            <li class="mb-10 ml-6 relative">

              <!-- Dot -->
              <span class="absolute -left-3.5 flex items-center justify-center w-7 h-7 rounded-full ring-4
                {% if s.status == 'approved' %} bg-green-500 ring-green-200
                {% elif s.status == 'pending' %} bg-orange-500 ring-orange-200
                {% else %} bg-gray-400 ring-gray-200 {% endif %}">
              </span>

              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <!-- Approver Info -->
                <div>
                  <p class="font-medium text-gray-800">
                    {% if s.flow.approver %}
                      {{ s.flow.approver.full_name }}
                    {% else %}
                      Approver not assigned
                    {% endif %}
                  </p>

                  {% if s.status == 'approved' %}
                    <p class="text-sm text-green-600">
                      Approved at: {{ s.approved_at|date:"M d, H:i" }}
                    </p>
                  {% elif s.status == 'pending' %}
                    <p class="text-sm text-orange-600">Pending</p>
                  {% else %}
                    <p class="text-sm text-gray-400">Upcoming</p>
                  {% endif %}
                </div>

                <!-- Status badge small + approved date -->
                <div class="flex flex-col items-end space-y-1 mt-2 sm:mt-0">
                  <span class="text-xs px-2 py-1 rounded-full
                    {% if s.status == 'approved' %} bg-green-100 text-green-700
                    {% elif s.status == 'pending' %} bg-orange-100 text-orange-700
                    {% else %} bg-gray-200 text-gray-700 {% endif %}">
                    {{ s.status|title }}
                  </span>

                  {% if s.status == 'approved' and s.approved_at %}
                    <span class="text-[11px] text-green-600">
                      {{ s.approved_at|date:"M d, Y H:i" }}
                    </span>
                  {% endif %}
                </div>

              </div>

            </li>
            {% endfor %}

          </ul>
        </div>
      </div>

    </div>

  </div>
  {% endfor %}

</div>
{% else %}
<p class="text-gray-500 text-center py-6">No approvals found.</p>
{% endif %}
